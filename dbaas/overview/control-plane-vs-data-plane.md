# Control Plane vs Data Plane

Фундаментальное архитектурное разделение в DBaaS: управление инстансами vs обработка данных.

## Control Plane

Управляющая плоскость. Отвечает за жизненный цикл инстансов: создание, конфигурация, масштабирование, мониторинг, биллинг.

```
┌─────────────── Control Plane ───────────────┐
│                                              │
│  API Gateway → Orchestrator → State Machine  │
│                     │                        │
│              ┌──────┴──────┐                 │
│              │             │                 │
│         Scheduler    Config Manager          │
│              │             │                 │
│         Provisioner   Health Checker         │
│                                              │
│  Metadata DB │ Billing │ IAM │ Monitoring    │
└──────────────────────────────────────────────┘
```

**Компоненты:**
- **API Gateway** — входная точка для пользовательских запросов (REST/gRPC)
- **Orchestrator** — управляет жизненным циклом инстансов
- **State Machine** — трекает состояние каждого инстанса
- **Scheduler** — выбирает где разместить инстанс
- **Provisioner** — создаёт ресурсы (VM, диски, сети)
- **Config Manager** — управляет конфигурацией СУБД
- **Health Checker** — мониторинг здоровья инстансов

**Характеристики:**
- Stateful (хранит метаданные обо всех инстансах)
- Относительно небольшая нагрузка (управляющие операции)
- Высокие требования к надёжности — downtime CP = нельзя управлять инстансами
- Обычно централизованный (один CP на регион или глобально)

## Data Plane

Плоскость данных. Непосредственно обрабатывает пользовательские запросы к базам данных.

```
┌─────────────── Data Plane ──────────────────┐
│                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │Instance A│  │Instance B│  │Instance C│  │
│  │PostgreSQL│  │PostgreSQL│  │  MySQL   │  │
│  │+ Agent   │  │+ Agent   │  │+ Agent   │  │
│  └──────────┘  └──────────┘  └──────────┘  │
│                                              │
│  Agent: metrics, logs, health, config sync   │
└──────────────────────────────────────────────┘
```

**Компоненты:**
- **DB Instance** — собственно СУБД (PostgreSQL, MySQL и т.д.)
- **Agent (sidecar)** — агент на каждом инстансе для связи с Control Plane
- **Proxy** — маршрутизация подключений, connection pooling
- **Storage** — локальные диски или network-attached (EBS, Ceph)

**Характеристики:**
- Обрабатывает пользовательский трафик (SQL-запросы)
- Высокие требования к latency и throughput
- Распределённый по зонам/регионам
- Масштабируется с количеством инстансов

## Разделение ответственности

| Аспект | Control Plane | Data Plane |
|--------|:---:|:---:|
| Создание инстанса | ✓ | |
| SQL-запросы | | ✓ |
| Бэкапы (инициация) | ✓ | |
| Бэкапы (выполнение) | | ✓ |
| Мониторинг (сбор) | | ✓ |
| Мониторинг (агрегация, алерты) | ✓ | |
| Failover (детекция) | ✓ | ✓ |
| Failover (переключение) | ✓ | |
| Биллинг | ✓ | |
| Metering (сбор usage) | | ✓ |

## Принципы проектирования

1. **CP downtime ≠ DP downtime** — если Control Plane недоступен, базы данных продолжают работать. Пользователи не смогут создавать/менять инстансы, но существующие работают.

2. **Blast radius** — проблема в CP затрагивает управление, проблема в DP затрагивает данные. Изолируй максимально.

3. **Agent-based communication** — DP агент подключается к CP (pull-модель), а не CP подключается к инстансам. Это упрощает сетевую изоляцию.

4. **Eventual consistency** — состояние в CP может отставать от реального состояния инстанса. Агент периодически синхронизирует.

# Consistency (Согласованность)

## CAP теорема

В распределённой системе при network partition можно гарантировать только два из трёх свойств:

- **C (Consistency)** — все узлы видят одни и те же данные в один момент времени
- **A (Availability)** — каждый запрос получает ответ (не обязательно актуальный)
- **P (Partition tolerance)** — система работает при потере связи между узлами

**На практике:** Partition tolerance обязателен → выбор между CP и AP.

| Тип | Описание | Примеры |
|-----|----------|---------|
| CP | Консистентность важнее доступности | etcd, ZooKeeper, Spanner |
| AP | Доступность важнее консистентности | Cassandra, DynamoDB, CouchDB |

## Модели консистентности

### Strong Consistency (Linearizability)

Самая строгая модель. Каждая операция выглядит атомарной и мгновенной. После записи все читатели видят новое значение.

```
Write(x=1) ─────┐
                 │ ← после этого момента
Read(x) → 1 ────┘   все читают 1
```

**Цена:** высокая latency (ожидание кворума), недоступность при partition.

### Sequential Consistency

Все операции упорядочены, и порядок операций каждого клиента сохранён. Но глобальный порядок может отличаться от wall-clock.

### Causal Consistency

Причинно-связанные операции видны в правильном порядке. Несвязанные — могут быть в любом.

```
Client A: Write(x=1) → Write(y=2)
Client B: Read(x=1) → гарантированно может прочитать y=2
```

### Eventual Consistency

Если запись прекращается, все реплики в конечном итоге придут к одному состоянию.

```
Write(x=1) на Node A
Read(x) на Node B → может вернуть старое значение
... через некоторое время ...
Read(x) на Node B → 1
```

**Проблемы:**
- Read-your-writes не гарантирован
- Конфликты при concurrent writes

## PACELC

Расширение CAP: если нет Partition → выбор между Latency и Consistency.

```
if Partition → choose A or C
else         → choose L or C
```

| Система | PA/PC | EL/EC |
|---------|-------|-------|
| DynamoDB | PA | EL |
| Cassandra | PA | EL |
| MongoDB | PC | EC |
| Spanner | PC | EC |

## Уровни consistency в БД

| Уровень | Описание |
|---------|----------|
| Read uncommitted | Видны незакоммиченные данные |
| Read committed | Только закоммиченные данные |
| Repeatable read | Повторное чтение даёт тот же результат |
| Serializable | Полная изоляция, как последовательное выполнение |

## Конфликты и их разрешение

### Last Write Wins (LWW)
Последняя запись (по timestamp) побеждает. Просто, но теряет данные.

### Vector Clocks
Отслеживают причинно-следственные связи. Обнаруживают конфликты для ручного разрешения.

### CRDTs (Conflict-free Replicated Data Types)
Структуры данных, гарантирующие конвергенцию без координации. Примеры: G-Counter, OR-Set.
